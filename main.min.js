$(function(){let t="users",o="currentUser";function s(e){e.addClass("error").removeClass("valid")}function l(e){e.removeClass("error").addClass("valid")}function c(e){e.removeClass("error valid")}function d(e,t){$(e).text(t).css("margin-top","10px")}function u(e){let t=$("#notification");t.length&&(t.text(e).addClass("show"),setTimeout(()=>t.removeClass("show"),3e3))}function m(){return JSON.parse(localStorage.getItem(t))||[]}function v(e){localStorage.setItem(t,JSON.stringify(e))}function e(){localStorage.removeItem(o),location.reload()}var a;localStorage.getItem(t)||$.getJSON("data/users.json").done(e=>v(e)).fail(()=>v([])),$("#registerForm").on("submit",function(e){e.preventDefault();var e=$("#name"),t=$("#password"),a=$("#confirmPassword");let r=$("#email");var i=$("#terms");let n=!1;c(e),c(t),c(a),c(r),0===e.val().length?(s(e),n=!0):l(e),t.val().length<8?(s(t),n=!0):l(t),t.val()!==a.val()?(s(a),n=!0):l(a),r.val().includes("@")?l(r):(s(r),n=!0),i.is(":checked")?i.closest(".form-checkbox").removeClass("error"):(n=!0,d("#regMessage","Необходимо принять условия использования"),i.closest(".form-checkbox").addClass("error")),n?d("#regMessage","Проверьте поля формы"):(a=m()).some(e=>e.email===r.val())?(d("#regMessage","Пользователь уже существует"),s(r)):(i={id:Date.now(),name:e.val(),email:r.val(),password:t.val(),role:"user"},a.push(i),v(a),localStorage.setItem(o,JSON.stringify(i)),u("Регистрация прошла успешно!"),setTimeout(()=>window.location.href="cars.html",1e3))}),$("#loginForm").on("submit",function(e){e.preventDefault();let t=$(this).find("[name='email']");e=$(this).find("[name='password']");c(t),c(e),t.val().includes("@")?l(t):(s(t),d("#loginMessage","Некорректный email")),e.val().length<8?(s(e),d("#loginMessage","Пароль должен быть не менее 8 символов")):l(e);var a=m().find(e=>e.email===t.val());a?a.password!==e.val()?(d("#loginMessage","Неверный пароль"),s(e)):(localStorage.setItem(o,JSON.stringify(a)),u("Вход выполнен!"),setTimeout(()=>{window.location.href="cars.html"},1e3)):(d("#loginMessage","Пользователь с таким email не найден"),s(t))}),(a=JSON.parse(localStorage.getItem(o)))?($("#authButtons").hide(),$("#userInfo").show(),$("#userName").text(a.name),$("#userRole").text("admin"===a.role?"(Администратор)":"(Пользователь)"),$("#logoutBtn").off("click").on("click",e)):($("#authButtons").show(),$("#userInfo").hide()),$("input").on("input",function(){$(this).removeClass("error")})});let carsData=[];$(document).ready(function(){let s=Vue.createApp,t="cart",a="data/cars.json",r="cars",i="new";function l(){return JSON.parse(localStorage.getItem(t))||[]}function c(e){localStorage.setItem(t,JSON.stringify(e))}function d(e){return"$"+e.toLocaleString()}function n(){return JSON.parse(localStorage.getItem("currentUser"))}function o(){var e=n();return e&&"admin"===e.role}function u(e){localStorage.setItem(r,JSON.stringify(e))}function m(e){let i=$(".products-grid");i.empty(),e.forEach(t=>{var e=t.images.map(e=>`
        <div class="slide">
          <img src="images/${e}" alt="${t.title}">
        </div>
      `).join(""),a=o()?'<button class="admin-delete-btn">Удалить</button>':"",r=(r=n())&&"user"===r.role?'<div class="vue-add-wrapper"></div>':"",e=`
        <div class="card" data-id="${t.id}">
          <div class="card-slider">
            ${e}
          </div>
          <h5>${t.title}</h5>
          <div class="price">${d(t.price)}</div>
          ${r}
          ${a}
        </div>
      `;i.append(e)}),document.querySelectorAll(".vue-add-wrapper").forEach(e=>{e.__vueMounted||(e.__vueMounted=!0,s({data(){return{added:!1}},computed:{text(){return this.added?"✓ Добавлено":"Добавить в заказ"}},methods:{add(){this.added||(this.added=!0,$(this.$el).closest(".card").find(".add-to-order-btn").trigger("jquery-add"),setTimeout(()=>{this.added=!1},1500))}},template:`
          <button
            class="add-to-order-btn"
            :disabled="added"
            @click="add"
          >
            {{ text }}
          </button>
        `}).mount(e))})}function v(e){var t=[...carsData];"cheap"===e&&t.sort((e,t)=>e.price-t.price),"expensive"===e&&t.sort((e,t)=>t.price-e.price),"new"===e&&t.sort((e,t)=>t.id-e.id),m(t)}function p(){var e=l();let t=0;e.forEach(e=>{t+=e.price*e.qty});var a=t?5e3:0,r=t?12e3:0,i=t?8500:0,n=t+a+r+i;let o=window.location.pathname.includes("makeOrder.html");$("#cartItems").length&&($("#cartCount").text(e.length),0===$("#cartItemsContainer").length&&$("#cartItems").length&&$("#cartItems").append('<div id="cartItemsContainer"></div>'),$("#cartItemsContainer").empty(),0===e.length?$("#cartItemsContainer").html(`
          <div class="empty-cart">
            <h3>Ваша корзина пуста</h3>
            <a href="cars.html" class="btn-back-to-shop">Перейти к покупкам</a>
          </div>
        `):e.forEach((e,t)=>{var a=!o?`<div class="vue-remove-wrapper" data-index="${t}"></div>`:"",t=`
            <div class="cart-item">

              <div class="item-qty">
                <button class="qty-btn minus" data-index="${t}">−</button>
                <span>${e.qty}</span>
                <button class="qty-btn plus" data-index="${t}">+</button>
              </div>

              <div class="item-image">
                <img src="${e.img}" alt="${e.title}">
              </div>
              <div class="item-info">
                <h3>${e.title}</h3>
                <div class="item-price">${d(e.price)}</div>
              </div>
              ${a}
            </div>
          `;$("#cartItemsContainer").append(t)}),$("#sumPrice").text(d(t)),$("#delivery").text(d(a)),$("#insurance").text(d(r)),$("#customs").text(d(i)),$("#total").text(d(n))),document.querySelectorAll(".vue-remove-wrapper").forEach(e=>{e.__vueMounted||(e.__vueMounted=!0,s({methods:{remove(){var e=this.$el.parentElement.dataset.index,t=l();t.splice(Number(e),1),c(t),p()}},template:'<button class="item-remove" @click="remove">Удалить</button> '}).mount(e))})}var e;function g(e=[]){return e.map(e=>e.toLowerCase().replace(/\s+/g," ").trim())}function h(){let e=[...carsData],t=$(".keywords input").val().toLowerCase().trim(),a=(t&&(e=e.filter(e=>e.title.toLowerCase().includes(t)||(e.keywords||[]).some(e=>e.toLowerCase().includes(t)))),+$(".price-filter input").val()),r=(e=e.filter(e=>e.price<=a),g($(".filter-row input:checked").map((e,t)=>t.value).get())),i=(r.length&&(e=e.filter(e=>{let t=g(e.features||[]);return r.every(e=>t.includes(e))})),g($(".dropdown:eq(0) input:checked").map((e,t)=>t.value).get())),n=(i.length&&(e=e.filter(e=>i.includes(e.color.toLowerCase()))),g($(".dropdown:eq(1) input:checked").map((e,t)=>t.value).get()));m(e=n.length?e.filter(t=>n.every(e=>g(t.services||[]).includes(e))):e)}$(".products-grid").length&&$.getJSON(a,function(e){var t=JSON.parse(localStorage.getItem(r));t?(carsData=t,v(i)):$.getJSON(a,function(e){u(carsData=e),v(i)})}),$(document).on("click",".admin-delete-btn",function(){if(o()){let t=$(this).closest(".card").data("id");u(carsData=carsData.filter(e=>e.id!==t)),m(carsData)}}),$(".chip").on("click",function(){$(".chip").removeClass("active"),$(this).addClass("active");var e=$(this).text();"Новые"===e&&(i="new"),"Дешевле"===e&&(i="cheap"),v(i="Дороже"===e?"expensive":i)}),$(document).on("jquery-add",".add-to-order-btn",function(){var e=$(this).closest(".card");let t={id:e.data("id"),title:e.find("h5").text(),price:parseInt(e.find(".price").text().replace(/\D/g,"")),img:e.find("img").first().attr("src")};var e=l(),a=e.find(e=>e.id===t.id);a?a.qty+=1:e.push({...t,qty:1}),c(e),p()}),0<(e=l()).length&&($("#cartItems").length||$("#cartItemsContainer").length)&&(console.log("Загружаем корзину из localStorage:",e),p()),$(".products-grid").length&&(e=l(),$("#cartCount").text(e.length)),p(),$(document).on("click",".qty-btn.plus",function(){var e=$(this).data("index"),t=l();t[e].qty+=1,c(t),p()}),$(document).on("click",".qty-btn.minus",function(){var e=$(this).data("index"),t=l();--t[e].qty,t[e].qty<=0&&t.splice(e,1),c(t),p()}),$(".add-btn").on("click",h),$(".filter-row input").on("change",h),$(".dropdown input").on("change",h),$(".price-filter input").on("input",h)});