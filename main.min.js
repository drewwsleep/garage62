$(function(){let t="users",s="currentUser";function n(e){e.addClass("error").removeClass("valid")}function l(e){e.removeClass("error").addClass("valid")}function c(e){e.removeClass("error valid")}function d(e,t){$(e).text(t).css("margin-top","10px")}function m(e){let t=$("#notification");t.length&&(t.text(e).addClass("show"),setTimeout(()=>t.removeClass("show"),3e3))}function u(){return JSON.parse(localStorage.getItem(t))||[]}function v(e){localStorage.setItem(t,JSON.stringify(e))}function e(){localStorage.removeItem(s),location.reload()}var a;localStorage.getItem(t)||$.getJSON("data/users.json").done(e=>v(e)).fail(()=>v([])),$("#registerForm").on("submit",function(e){e.preventDefault();var e=$("#name"),t=$("#password"),a=$("#confirmPassword");let r=$("#email");var i=$("#terms");let o=!1;c(e),c(t),c(a),c(r),0===e.val().length?(n(e),o=!0):l(e),t.val().length<8?(n(t),o=!0):l(t),t.val()!==a.val()?(n(a),o=!0):l(a),r.val().includes("@")?l(r):(n(r),o=!0),i.is(":checked")?i.closest(".form-checkbox").removeClass("error"):(o=!0,d("#regMessage","Необходимо принять условия использования"),i.closest(".form-checkbox").addClass("error")),o?d("#regMessage","Проверьте поля формы"):(a=u()).some(e=>e.email===r.val())?(d("#regMessage","Пользователь уже существует"),n(r)):(i={id:Date.now(),name:e.val(),email:r.val(),password:t.val(),role:"user"},a.push(i),v(a),localStorage.setItem(s,JSON.stringify(i)),m("Регистрация прошла успешно!"),setTimeout(()=>window.location.href="cars.html",1e3))}),$("#loginForm").on("submit",function(e){e.preventDefault();let t=$(this).find("[name='email']");e=$(this).find("[name='password']");c(t),c(e),t.val().includes("@")?l(t):(n(t),d("#loginMessage","Некорректный email")),e.val().length<8?(n(e),d("#loginMessage","Пароль должен быть не менее 8 символов")):l(e);var a=u().find(e=>e.email===t.val());a?a.password!==e.val()?(d("#loginMessage","Неверный пароль"),n(e)):(localStorage.setItem(s,JSON.stringify(a)),m("Вход выполнен!"),setTimeout(()=>{window.location.href="cars.html"},1e3)):(d("#loginMessage","Пользователь с таким email не найден"),n(t))}),(a=JSON.parse(localStorage.getItem(s)))?($("#authButtons").hide(),$("#userInfo").show(),$("#userName").text(a.name),$("#userRole").text("admin"===a.role?"(Администратор)":"(Пользователь)"),$("#logoutBtn").off("click").on("click",e)):($("#authButtons").show(),$("#userInfo").hide()),$("input").on("input",function(){$(this).removeClass("error")})}),$(document).ready(function(){let n=Vue.createApp,t="cart";var e;let a="cars",r=[],i="new";function l(){return JSON.parse(localStorage.getItem(t))||[]}function c(e){localStorage.setItem(t,JSON.stringify(e))}function d(e){return"$"+e.toLocaleString()}function o(){return JSON.parse(localStorage.getItem("currentUser"))}function s(){var e=o();return e&&"admin"===e.role}function m(e){localStorage.setItem(a,JSON.stringify(e))}function u(e){let i=$(".products-grid");i.empty(),e.forEach(t=>{var e=t.images.map(e=>`
        <div class="slide">
          <img src="images/${e}" alt="${t.title}">
        </div>
      `).join(""),a=s()?'<button class="admin-delete-btn">Удалить</button>':"",r=(r=o())&&"user"===r.role?'<div class="vue-add-wrapper"></div>':"",e=`
        <div class="card" data-id="${t.id}">
          <div class="card-slider">
            ${e}
          </div>
          <h5>${t.title}</h5>
          <div class="price">${d(t.price)}</div>
          ${r}
          ${a}
        </div>
      `;i.append(e)}),document.querySelectorAll(".vue-add-wrapper").forEach(e=>{e.__vueMounted||(e.__vueMounted=!0,n({data(){return{added:!1}},computed:{text(){return this.added?"✓ Добавлено":"Добавить в заказ"}},methods:{add(){this.added||(this.added=!0,$(this.$el).closest(".card").find(".add-to-order-btn").trigger("jquery-add"),setTimeout(()=>{this.added=!1},1500))}},template:`
          <button
            class="add-to-order-btn"
            :disabled="added"
            @click="add"
          >
            {{ text }}
          </button>
        `}).mount(e))})}function v(e){var t=[...r];"cheap"===e&&t.sort((e,t)=>e.price-t.price),"expensive"===e&&t.sort((e,t)=>t.price-e.price),"new"===e&&t.sort((e,t)=>t.id-e.id),u(t)}function g(){var e=l();let t=0;e.forEach(e=>t+=e.price);var a=t?5e3:0,r=t?12e3:0,i=t?8500:0,o=t+a+r+i;let s=window.location.pathname.includes("makeOrder.html");$("#cartItems").length&&($("#cartCount").text(e.length),0===$("#cartItemsContainer").length&&$("#cartItems").length&&$("#cartItems").append('<div id="cartItemsContainer"></div>'),$("#cartItemsContainer").empty(),0===e.length?$("#cartItemsContainer").html(`
          <div class="empty-cart">
            <h3>Ваша корзина пуста</h3>
            <a href="cars.html" class="btn-back-to-shop">Перейти к покупкам</a>
          </div>
        `):e.forEach((e,t)=>{t=!s?`<div class="vue-remove-wrapper" data-index="${t}"></div>`:"",e=`
            <div class="cart-item">
              <div class="item-image">
                <img src="${e.img}" alt="${e.title}">
              </div>
              <div class="item-info">
                <h3>${e.title}</h3>
                <div class="item-price">${d(e.price)}</div>
              </div>
              ${t}
            </div>
          `;$("#cartItemsContainer").append(e)}),$("#sumPrice").text(d(t)),$("#delivery").text(d(a)),$("#insurance").text(d(r)),$("#customs").text(d(i)),$("#total").text(d(o))),document.querySelectorAll(".vue-remove-wrapper").forEach(e=>{e.__vueMounted||(e.__vueMounted=!0,n({methods:{remove(){var e=this.$el.parentElement.dataset.index,t=l();t.splice(Number(e),1),c(t),g()}},template:'<button class="item-remove" @click="remove">Удалить</button> '}).mount(e))})}$(".products-grid").length&&((e=JSON.parse(localStorage.getItem(a)))?(r=e,v(i)):$.getJSON("data/cars.json",function(e){m(r=e),v(i)})),$(document).on("click",".admin-delete-btn",function(){if(s()){let t=$(this).closest(".card").data("id");m(r=r.filter(e=>e.id!==t)),u(r)}}),$(".chip").on("click",function(){$(".chip").removeClass("active"),$(this).addClass("active");var e=$(this).text();"Новые"===e&&(i="new"),"Дешевле"===e&&(i="cheap"),v(i="Дороже"===e?"expensive":i)}),$(document).on("jquery-add",".add-to-order-btn",function(){var e=$(this).closest(".card"),e={id:e.data("id"),title:e.find("h5").text(),price:parseInt(e.find(".price").text().replace(/\D/g,"")),img:e.find("img").first().attr("src")},t=l();t.push(e),c(t),g()}),0<(e=l()).length&&($("#cartItems").length||$("#cartItemsContainer").length)&&(console.log("Загружаем корзину из localStorage:",e),g()),$(".products-grid").length&&(e=l(),$("#cartCount").text(e.length)),g()});